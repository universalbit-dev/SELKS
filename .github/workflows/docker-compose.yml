name: Docker Compose CI (Build Dashboard, HTTPS smoke test + Pages)

on:
  push:
  pull_request:
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  build-and-test-and-pages:
    runs-on: ubuntu-latest
    timeout-minutes: 90

    env:
      # Services to treat as non-fatal if unhealthy (space-separated substrings)
      IGNORE_UNHEALTHY_SERVICES: "docker-db-1 db"
      # Path of host bind-mount dir for DB (adjust if different)
      DB_BIND_DIR: "docker/containers-data/db/data"
      DB_CONTAINER_NAME: "docker-db-1"
      COMPOSE_HTTP_TIMEOUT: "600"
      COMPOSE_WAIT_LONG: "600"
      # artifact files created in workflow workspace
      COMPOSE_LOGS_FILE: "compose_logs.txt"
      DB_LOGS_FILE: "docker-db-1.logs"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js (for frontend build)
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Install frontend dependencies and build (if package.json exists)
        run: |
          if [[ -f package.json ]]; then
            npm ci
            if npm run | grep -q "build"; then npm run build; fi
          fi

      - name: Ensure docker compose plugin exists
        run: |
          if ! docker compose version >/dev/null 2>&1; then
            sudo apt-get update
            sudo apt-get install -y docker-compose-plugin
          fi
          docker compose version

      - name: Prepare host volume directories used by bind mounts
        run: |
          set -e
          mkdir -p docker/containers-data/suricata/logrotate docker/containers-data/suricata/run docker/containers-data/suricata/rules \
                   docker/containers-data/scirius/static docker/containers-data/scirius/data docker/containers-data/arkime/pcap \
                   docker/containers-data/db/data docker/containers-data/elastic/data docker/containers-data/logstash/sincedb || true
          ls -la docker || true
          ls -la docker/containers-data || true

      - name: Start docker-compose stack (build & up)
        working-directory: docker
        env:
          COMPOSE_HTTP_TIMEOUT: ${{ env.COMPOSE_HTTP_TIMEOUT }}
        run: |
          # start services (do not fail the workflow here if compose returns non-zero)
          docker compose up -d --build || true

      - name: Save initial compose ps
        working-directory: docker
        run: |
          docker compose ps || true
          docker ps --format 'table {{.Names}}\t{{.Image}}\t{{.Status}}' || true

      - name: Wait for containers' health (non-fatal for ignored services)
        working-directory: docker
        run: |
          set -euo pipefail
          IGNORE_LIST="${{ env.IGNORE_UNHEALTHY_SERVICES }}"
          COMPOSE_LOGS_PATH="$GITHUB_WORKSPACE/${{ env.COMPOSE_LOGS_FILE }}"
          DB_LOGS_PATH="$GITHUB_WORKSPACE/${{ env.DB_LOGS_FILE }}"
          TIMEOUT_SECS=${COMPOSE_WAIT_LONG}
          SLEEP_INTERVAL=5
          MAX_TRIES=$((TIMEOUT_SECS / SLEEP_INTERVAL))

          # Collect container names started by compose
          CONTAINERS=$(docker compose ps --services --quiet 2>/dev/null || true)
          if [[ -n "$CONTAINERS" ]]; then
            NAMES=""
            for svc in $CONTAINERS; do
              CN=$(docker ps --filter "label=com.docker.compose.service=$svc" --format '{{.Names}}' | head -n1 || true)
              if [[ -n "$CN" ]]; then NAMES="$NAMES $CN"; fi
            done
            CONTAINERS="$NAMES"
          else
            CONTAINERS=$(docker ps --format '{{.Names}}' | grep -E 'docker-' || true)
          fi

          if [[ -z "$CONTAINERS" ]]; then
            echo "No containers found; dumping docker compose ps and continuing."
            docker compose ps || true
          fi

          echo "Containers to check: $CONTAINERS"

          FAILED=0
          IGNORED_FAILED=0

          is_ignored() {
            local name="$1"
            for s in $IGNORE_LIST; do
              if [[ "$name" == "$s" || "$name" == *"$s"* ]]; then
                return 0
              fi
            done
            return 1
          }

          for C in $CONTAINERS; do
            echo "Checking health for container: $C"
            STATUS=""
            for try in $(seq 1 $MAX_TRIES); do
              HEALTH_JSON=$(docker inspect --format='{{json .State.Health}}' "$C" 2>/dev/null || echo "")
              if [[ -z "$HEALTH_JSON" ]]; then
                STATE=$(docker inspect --format='{{.State.Status}}' "$C" 2>/dev/null || echo "not_found")
                echo "  No Health object for $C; State.Status=$STATE"
                if [[ "$STATE" == "running" ]]; then
                  STATUS="nohealth"
                  break
                fi
              else
                HEALTH_STATUS=$(docker inspect --format='{{.State.Health.Status}}' "$C" 2>/dev/null || echo "")
                echo "  Health status: $HEALTH_STATUS"
                if [[ "$HEALTH_STATUS" == "healthy" ]]; then
                  STATUS="healthy"
                  break
                fi
                if [[ "$HEALTH_STATUS" == "unhealthy" ]]; then
                  STATUS="unhealthy"
                fi
              fi
              sleep $SLEEP_INTERVAL
            done

            if [[ "$STATUS" == "healthy" || "$STATUS" == "nohealth" ]]; then
              echo "Container $C OK (status=$STATUS)"
            else
              echo "Container $C failed to become healthy (status=${STATUS:-unknown})"
              echo "Inspecting $C and capturing logs..."
              docker inspect "$C" || true
              docker logs --tail 1000 "$C" || true

              # write logs to workspace for artifact upload
              docker compose logs --no-color > "$COMPOSE_LOGS_PATH" || true
              docker logs --tail 2000 "$C" > "$DB_LOGS_PATH" 2>&1 || true

              if is_ignored "$C"; then
                echo "Container $C matches IGNORE_UNHEALTHY_SERVICES -> treating as NON-FATAL warning"
                IGNORED_FAILED=1
                # Attempt best-effort remediation (chown host DB bind dir & recreate) only for db-like names
                if [[ "$C" == "${{ env.DB_CONTAINER_NAME }}" || "$C" =~ db ]]; then
                  echo "Attempting remediation for $C (best-effort)"
                  HOST_DB_DIR="$GITHUB_WORKSPACE/${{ env.DB_BIND_DIR }}"
                  # try common uids (best-effort)
                  for uid in 1000 999; do
                    sudo chown -R "${uid}:${uid}" "$HOST_DB_DIR" || true
                  done
                  docker compose up -d --no-deps --force-recreate db || docker compose up -d --no-deps --force-recreate || true
                fi
              else
                echo "Container $C is NOT ignored -> marking as fatal"
                FAILED=1
              fi
            fi
          done

          # Always persist latest logs for artifact upload
          docker compose logs --no-color > "$COMPOSE_LOGS_PATH" || true

          echo "Health check summary: FAILED=$FAILED IGNORED_FAILED=$IGNORED_FAILED"

          # If there were fatal failures, fail the step (and job). Otherwise continue.
          if [[ $FAILED -ne 0 ]]; then
            echo "One or more non-ignored containers failed health checks -> failing job."
            exit 1
          fi

          if [[ $IGNORED_FAILED -ne 0 ]]; then
            echo "One or more ignored containers are unhealthy (non-fatal). See $COMPOSE_LOGS_PATH and $DB_LOGS_PATH"
          fi

      - name: Run tests / HTTPS smoke test (continue even if some ignored services unhealthy)
        working-directory: docker
        run: |
          set -e
          # Example smoke test (non-fatal if fails)
          if curl -k --silent --show-error --fail https://localhost:443/ -I; then
            echo "HTTPS reachable"
          else
            echo "HTTPS not reachable â€” continuing (non-fatal)."
          fi

      - name: Snapshot dashboard HTML (for Pages visualization)
        working-directory: docker
        run: |
          mkdir -p ../pages-site
          if curl -k --max-time 10 --silent --show-error https://localhost:443/ -o ../pages-site/dashboard_snapshot.html; then
            echo "Saved dashboard snapshot"
          else
            echo "<!-- snapshot failed -->" > ../pages-site/dashboard_snapshot.html || true
          fi

      - name: Collect logs & create pages site
        working-directory: docker
        run: |
          PAGES_DIR=../pages-site
          mkdir -p "$PAGES_DIR"
          # Copy workspace logs into pages site (best-effort)
          cp "$GITHUB_WORKSPACE/${{ env.COMPOSE_LOGS_FILE }}" "$PAGES_DIR/compose_logs.txt" || true
          cp "$GITHUB_WORKSPACE/${{ env.DB_LOGS_FILE }}" "$PAGES_DIR/docker-db-1.logs" || true
          ls -la "$PAGES_DIR"

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages-site

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v2

      - name: Upload debug artifacts (always)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: docker-compose-debug
          path: |
            ${{ env.COMPOSE_LOGS_FILE }}
            ${{ env.DB_LOGS_FILE }}

      - name: Tear down compose stack
        if: always()
        working-directory: docker
        run: |
          docker compose down --volumes --remove-orphans || true
