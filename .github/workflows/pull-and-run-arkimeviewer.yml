on:
  workflow_dispatch:

# Minimal permissions required for checkout and reading GHCR packages
permissions:
  contents: read
  packages: read

env:
  IMAGE: ghcr.io/universalbit-dev/arkimeviewer:snyk-fix-512a575e2bccee962042801ef03bb3d2
  CONTAINER_NAME: arkimeviewer
  HOST_PORT: 8443    
  CONTAINER_PORT: 443

jobs:
  pull-and-run:
    name: Pull image and start container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout (not strictly needed, but useful to have)
        uses: actions/checkout@v4

      # If the image is private, set a repository secret GHCR_PAT with a PAT that has read:packages.
      # Use the expression syntax ${{ ... }} in the `if:` â€” secrets can't be referenced directly without it.
      - name: Log in to GHCR (if GHCR_PAT secret is provided)
        if: ${{ secrets.GHCR_PAT != '' }}
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GHCR_PAT }}

      - name: Ensure existing container is stopped and removed
        run: |
          if sudo docker ps -a --format '{{.Names}}' | grep -x "${{ env.CONTAINER_NAME }}" >/dev/null 2>&1; then
            sudo docker rm -f "${{ env.CONTAINER_NAME }}" || true
          fi

      - name: Pull image
        run: sudo docker pull "${{ env.IMAGE }}"

      - name: Start container
        run: |
          sudo docker run -d \
            --name "${{ env.CONTAINER_NAME }}" \
            -p "${{ env.HOST_PORT }}:${{ env.CONTAINER_PORT }}" \
            --restart unless-stopped \
            "${{ env.IMAGE }}"
