on:
  workflow_dispatch:

# Minimal permissions for checkout and (optional) package access.
permissions:
  contents: read
  packages: read

jobs:
  pull-and-run:
    name: Pull image and start container
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # If your image is private and you need to log into GHCR, uncomment the next step
      # and add a repository secret named GHCR_PAT (PAT with read:packages).
      # Using docker/login-action with the secret in `with:` is supported (do not use `if:` with an unwrapped `secrets`).
      # - name: Log in to GHCR
      #   uses: docker/login-action@v2
      #   with:
      #     registry: ghcr.io
      #     username: ${{ github.actor }}
      #     password: ${{ secrets.GHCR_PAT }}

      - name: Pull and run Arkime Viewer
        run: |
          set -euo pipefail

          IMAGE="ghcr.io/universalbit-dev/arkimeviewer:snyk-fix-512a575e2bccee962042801ef03bb3d2"
          CONTAINER_NAME="arkimeviewer"
          HOST_PORT=8443
          CONTAINER_PORT=443

          echo "Stopping and removing any existing container named ${CONTAINER_NAME}..."
          if sudo docker ps -a --format '{{.Names}}' | grep -x "${CONTAINER_NAME}" >/dev/null 2>&1; then
            sudo docker rm -f "${CONTAINER_NAME}" || true
          fi

          echo "Pulling ${IMAGE}..."
          sudo docker pull "${IMAGE}"

          echo "Starting container ${CONTAINER_NAME} (host port ${HOST_PORT} -> container port ${CONTAINER_PORT})..."
          sudo docker run -d \
            --name "${CONTAINER_NAME}" \
            -p "${HOST_PORT}:${CONTAINER_PORT}" \
            --restart unless-stopped \
            "${IMAGE}"

          echo "Done."
